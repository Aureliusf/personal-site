<!DOCTYPE html>
<html lang="en">

<head>

  <!-- Minima -->
  <!-- Hexo theme created by @adisaktijrs -->

  <!-- Basic Page Needs
  ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì -->
  <meta charset="utf-8">

  
  <title>Serve n8n publicly with nixOS</title>
  
  <link rel="canonical" href="http://aurelioflorez.com/2025/06/25/nixOS/">
  
  <meta name="description" content="Serve n8n with nixOSI have seen nix and nixOS all over the internet and see how people swear by it and the rock solid deployments it can offer.  When ">
  
  
  <meta name="author" content="Aurelio Florez">
  
  <meta property="og:image" content="http://aurelioflorez.comundefined">
  
  <meta property="og:site_name" content="Aurelio Florez" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Serve n8n publicly with nixOS" />
  
  <meta property="og:description" content="Serve n8n with nixOSI have seen nix and nixOS all over the internet and see how people swear by it and the rock solid deployments it can offer.  When ">
  
  <meta property="og:url" content="http://aurelioflorez.com/2025/06/25/nixOS/" />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Serve n8n publicly with nixOS">
  
  <meta name="twitter:description" content="Serve n8n with nixOSI have seen nix and nixOS all over the internet and see how people swear by it and the rock solid deployments it can offer.  When ">
  
  
  <meta name="twitter:image" content="http://aurelioflorez.comundefined">
  
  <meta name="twitter:url" content="http://aurelioflorez.com/2025/06/25/nixOS/" />

  <!-- Mobile Specific Metas
  ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Preload fonts
  ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì -->
  <link rel="preload" href="../fonts/dm-serif-display-v4-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="../fonts/inter-v2-latin-regular.woff2" as="font" type="font/woff2" crossorigin>

  <!-- CSS
  ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì -->
  
<link rel="stylesheet" href="/css/normalize.css">

  
<link rel="stylesheet" href="/css/skeleton.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
<link rel="stylesheet" href="/css/prism-dark.css">

  
<link rel="stylesheet" href="/css/prism-line-numbers.css">

  <!-- User css -->
  
  
<link rel="stylesheet" href="/css/user.css">

  

  <!-- Favicon
  ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì -->
  <link rel="icon" type="image/png" href="/images/favicon.png">

  <!-- Custom Theme Color Style
  ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì -->
  <style>
  a:not(.icon) {
    text-decoration-color: #d3869b;
    background-image: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0) 50%,
      #d3869b 50%
    );
  }
  blockquote {
    border-left: 8px solid #d3869b;
  }
  .nanobar .bar {
    background: #d3869b;
  }
  .button.button-primary:hover,
  button.button-primary:hover,
  input[type="submit"].button-primary:hover,
  input[type="reset"].button-primary:hover,
  input[type="button"].button-primary:hover,
  .button.button-primary:focus,
  button.button-primary:focus,
  input[type="submit"].button-primary:focus,
  input[type="reset"].button-primary:focus,
  input[type="button"].button-primary:focus {
    background-color: #d3869b;
    border-color: #d3869b;
  }
  input[type="email"]:focus,
  input[type="number"]:focus,
  input[type="search"]:focus,
  input[type="text"]:focus,
  input[type="tel"]:focus,
  input[type="url"]:focus,
  input[type="password"]:focus,
  textarea:focus,
  select:focus {
    border: 1px solid #d3869b;
  }
</style>

  <!-- Google Analytics (With Privacy Settings On)
  ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì -->
  

<meta name="generator" content="Hexo 8.1.1"></head>

<body>
  <div class="container">
    <div class="row">
      <div>

        <div class="row">
  <div class="two columns" style="max-width: 50px">
    <h1 class="mt-2 mode">
      <div onclick=setDarkMode(true) id="darkBtn">üåë</div>
      <div onclick=setDarkMode(false) id="lightBtn" class=hidden>‚òÄÔ∏è</div>
      <script >
        if (localStorage.getItem('preferredTheme') == 'dark') {
          setDarkMode(true)
        }
        function setDarkMode(isDark) {
          var darkBtn = document.getElementById('darkBtn')
          var lightBtn = document.getElementById('lightBtn')
          if (isDark) {
            lightBtn.style.display = "block"
            darkBtn.style.display = "none"
            localStorage.setItem('preferredTheme', 'dark');
          } else {
            lightBtn.style.display = "none"
            darkBtn.style.display = "block"
            localStorage.removeItem('preferredTheme');
          }
          document.body.classList.toggle("darkmode");
        }
      </script>
    </h1>
  </div>

      <div class="six columns ml-1">
        <h1 class="mt-2">
          Aurelio Florez
        </h1>
      </div>
      <!-- <p class="mt-2">he/him</p> -->
  <div class="twelve columns">
    <div class="row">
      <div class="nine columns left">
        <a href="/">Home</a>
        
          
          <a href="/archives" class="ml">Works</a>
          
        
          
          <a href="/Aurelio-Florez-resume.pdf" class="ml">Resume</a>
          
        
        
          
            <a href="mailto:mail@aurelioflorez.com" target="_blank" class="ml">Email</a>
          
        
      </div>
    </div>
    <hr style="margin-bottom: 2.6rem">
  </div>
</div>

        <div class="trans">
            <h2>Serve n8n publicly with nixOS</h2>

  <h1 id="Serve-n8n-with-nixOS"><a href="#Serve-n8n-with-nixOS" class="headerlink" title="Serve n8n with nixOS"></a>Serve n8n with nixOS</h1><p>I have seen nix and nixOS all over the internet and see how people swear by it and the rock solid deployments it can offer. </p>
<p>When I wanted to look deeper into n8n I took the opportunity to do both things at the same time, learn n8n and nix.</p>
<h1 id="n8n"><a href="#n8n" class="headerlink" title="n8n"></a>n8n</h1><p>n8n is a ‚ÄúFair-code workflow automation platform with native AI capabilities‚Äù. <a target="_blank" rel="noopener" href="https://github.com/n8n-io/n8n">n8n-io&#x2F;n8n</a><br>My tldr; better interface for zapier that my father can finally use and ü™Ñ AI ü™Ñ</p>
<p>n8n can be run with docker and more recently with npx directly.<br>Regretfully, I did not get the memo in time and started this project with docker instead before npx was a viable option. </p>
<p>nixOS is attractive due to the whole system being declarable on the configuration. And if there is things you want to leave non declarative, you can do so no problem!</p>
<p>Because the system is meant to be declarative and dependencies are separately stored. You can even use different versions of packages on the same system without interfering. Due to this new found capability with nixOS, the nix way to run services is not with a virtualization layer but directly on bare metal.</p>
<p>TBD will transfer from docker to running directly with npx. </p>
<p>To have run the container, it pretty much worked right away. n8n needs SSL certificates to work properly, other than that I used the docker compose on the docs changing a couple details and importing the DB secrets from an .env file</p>
<h1 id="nixOS"><a href="#nixOS" class="headerlink" title="nixOS"></a>nixOS</h1><p><a target="_blank" rel="noopener" href="https://nixos.wiki/">nixOS</a> is a Linux distribution based on the nix package manager that uses an immutable design and an atomic update model.<br>Its use of a declarative configuration system allows reproducibility, portability and a light server.</p>
<p>After grabbing the GUI installer to start familiarizing with the new distro I set up ssh keys and sshd service in the n8n-server machine to start treating it like a real server.</p>
<p>This is what I did to ensure ssh would be available every time the system boots and the right public keys are authorized.<br>Furthermore and to be better safe than sorry, fail2ban with some whitelisted local IPs.</p>
<pre><code class="highlight nix"><span class="comment"># SSH configs</span>
p<span class="attr">rograms.ssh.startAgent</span> <span class="operator">=</span> <span class="literal">true</span>;

<span class="comment"># Add github and public facing server keys every time</span>

<span class="attr">users.users.server.openssh.authorizedKeys.keys</span> <span class="operator">=</span> [
  <span class="string">&quot;/home/server/.ssh/github.pub&quot;</span>
  <span class="string">&quot;/home/server/.ssh/vultr.pub&quot;</span>
];

<span class="comment"># Enable the OpenSSH daemon.</span>
s<span class="attr">ervices.openssh</span> <span class="operator">=</span> &#123;
  <span class="attr">enable</span> <span class="operator">=</span> <span class="literal">true</span>;
  <span class="attr">settings</span> <span class="operator">=</span> &#123;
    <span class="attr">PasswordAuthentication</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment"># only key pairs üîë</span>
    <span class="attr">PrintMotd</span> <span class="operator">=</span> <span class="literal">true</span>;
  &#125;;
&#125;;

<span class="attr">services.fail2ban</span> <span class="operator">=</span> &#123;
  <span class="attr">enable</span> <span class="operator">=</span> <span class="literal">true</span>;
  <span class="attr">maxretry</span> <span class="operator">=</span> <span class="number">3</span>;
  <span class="attr">bantime-increment.enable</span> <span class="operator">=</span> <span class="literal">true</span>;
  <span class="attr">ignoreIP</span> <span class="operator">=</span> [
    <span class="string">&quot;127.0.0.1/8&quot;</span> <span class="comment"># local machine traffic</span>
    <span class="string">&quot;10.0.0.174&quot;</span> <span class="comment"># local network traffic</span>
    <span class="string">&quot;100.67.201.23&quot;</span> <span class="comment"># local tailscale traffic</span>
  ];
&#125;;</code></pre>

<p>In order to have access to n8n-server even when not at home and in line with the rest of my homelab, tailscale</p>
<pre><div class="caption"><span>nix</span></div><code class="highlight `">  # Enable Tailscale
  services.tailscale.enable = true;

  # Networking
  # Enable SSH access in from Tailscale network 22
  # Enable http/s traffic to go through 80 and 443 for access n8n thorugh tailscale
  networking.firewall = &#123;
    enable = true;
    trustedInterfaces = [&quot;tailscale0&quot;];
    allowedUDPPorts = [config.services.tailscale.port];
    allowedTCPPorts = [22 443 80];
  &#125;;

`````

One of the first big issues I faced was loosing my old configuration after I made breaking changes while trying to properly set up docker.
nixOS will *always* have a working build, that is true and extremely useful. If you run nixOS, you will never have a broken system, period.
BUT if you loose your old `configuration.nix` because of a change not tracked properly, you have lost it.

To fix this, you can set up nixOS to copy your config files to the appropriate system generation directory.
````nix
  # Copy the NixOS configuration file and link it from the resulting system
  # (/run/current-system/configuration.nix). This is useful in case you accidentally delete configuration.nix.
  system.copySystemConfiguration = true;
`````
This setting works even in more complex multi-file configuration system like in my regular dotfiles.

# Serve
The easiest and safest way I found to serve a locally hosted service through a public domain that can get Let&#x27;s Encrypt SSL certificates is with an ssh tunnel.
I started using Serveo with worked great BUT it would disconnect at once a day even when using autossh. For that I had to move into hosting my own public facing server.
I chose to use Vultr with the cheapest possible VPS. It runs nginx in an AlmaLinux system.

This is the flow for a given user:
```mermaid
graph TD
    A[Client Browser] --&gt;|HTTP/S Request| B(base.org.es)
    B --&gt;|&quot;DNS Resolution (Vultr)&quot;| C[Vultr Instance]
    C --&gt;|&quot;Nginx&quot;| D&#123;&quot;Vultr Internal Port 7575&quot;&#125;
    D --&gt;|&quot;SSH Tunnel (Vultr Side)&quot;| E((SSH Tunnel))
    E --&gt;|&quot;SSH Tunnel (Local Side)&quot;| F[Local nixOS n8n-server]
    F --&gt;|&quot;Local Port Forwarding&quot;| G(n8n container)

    subgraph Vultr Infrastructure
        C
        D
    end

    subgraph Local Infrastructure
        F
        G
    end

    %% Flow Explanations
    click A &quot;User&#x27;s browser initiates request&quot;
    click B &quot;Domain resolves to Vultr IP via DNS&quot;
    click C &quot;Nginx on Vultr instance receives request&quot;
    click D &quot;Nginx reverse proxies to internal Vultr port 7575&quot;
    click E &quot;SSH tunnel securely forwards traffic from Vultr port 7575 to your local machine&quot;
    click F &quot;Local machine receives forwarded traffic from SSH tunnel&quot;
    click G &quot;n8n server receives traffic on its local port&quot;
</code></pre>
<p>This way I don‚Äôt need to open any ports in my local network and open my homelab this way. With this ssh tunnel, traffic should only be able to access what is served on the local port is pointed to and nothing else. </p>
<p>This means that I am unable to ssh into my n8n-server through base.org.es at all even though sshd is running, even from one of the whitelisted IPs.</p>

  <p> ‚Äî Jun 25, 2025</p>
  


          <div class="row mt-2">
  
    <div class="eight columns">
      <p id="madewith">Made with ‚ù§ and
        <a class="footer-link icon" href="https://hexo.io" target="_blank" style="text-decoration: none;" rel="noreferrer" aria-label="Hexo.io">
        <svg class="hexo svg-hov" width="14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Hexo.js</title><path d="M12 .007L1.57 6.056V18.05L12 23.995l10.43-6.049V5.952L12 .007zm4.798 17.105l-.939.521-.939-.521V12.94H9.08v4.172l-.94.521-.938-.521V6.89l.939-.521.939.521v4.172h5.84V6.89l.94-.521.938.521v10.222z"/></svg>
        </a>
        
        at Miami.</p>
        
    </div>

    <!-- Special thanks to https://simpleicons.org/ for the icons -->
    <div class="four columns mb-3 posisi" >
      
      <a class="ml-0 footer-link icon" href="https://github.com/aureliusf" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="GitHub">
        <svg class="github svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
      </a>
      

      
      <a class="ml-0 footer-link icon" href="https://linkedin.com/in/aurelio-florez-621560221" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="LinkedIn">
        <svg class="linkedin svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
      </a>
      

      
      <a class="ml-0 footer-link icon" href="https://twitter.com/aurelioflorez" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="Twitter">
        <svg class="twitter svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"/></svg>
      </a>
      

    </div>
  
</div>

        </div>
      </div>

    </div>

  </div>
  <script src="/js/nanobar.min.js"></script>
  <script>
    var options = {
      classname: 'nanobar',
      id: 'myNanobar'
    };
    var nanobar = new Nanobar(options);
    nanobar.go(30);
    nanobar.go(76);
    nanobar.go(100);
  </script>

</body>

</html>
